<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMOLO.AI - Advanced Chatbot v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes typing { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        .animate-bounce-dot { animation: bounce 0.6s infinite; }
        .animate-bounce-dot:nth-child(2) { animation-delay: 0.15s; }
        .animate-bounce-dot:nth-child(3) { animation-delay: 0.3s; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .typing-indicator { animation: typing 1.4s infinite; }
        .dark-mode { background: linear-gradient(to bottom right, #1a1a2e, #16213e, #0f3460); }
        .dark-mode .bg-white { background: rgba(255,255,255,0.1) !important; }
        .dark-mode .text-gray-800 { color: #e0e0e0 !important; }
        .dark-mode .text-gray-600 { color: #b0b0b0 !important; }
        .dark-mode input { background: rgba(255,255,255,0.1) !important; color: white !important; }
        .dark-mode input::placeholder { color: rgba(255,255,255,0.5) !important; }
        .message-code { background: #f4f4f4; padding: 12px; border-radius: 8px; font-family: 'Courier New', monospace; overflow-x: auto; }
        .dark-mode .message-code { background: #2d2d2d; color: #f8f8f2; }
        .reaction-btn { cursor: pointer; padding: 4px 8px; border-radius: 12px; font-size: 14px; transition: all 0.2s; }
        .reaction-btn:hover { transform: scale(1.2); background: rgba(0,0,0,0.05); }
        .personality-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 8px; }
    </style>
</head>
<body class="min-h-screen transition-all duration-300" id="body">
    <div class="flex flex-col h-screen">
        <!-- Header with Controls -->
        <div class="flex flex-col items-center pt-8 pb-6 relative">
            <div class="absolute top-4 right-4 flex gap-2">
                <!-- Dark Mode Toggle -->
                <button id="theme-toggle" class="p-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors" title="Toggle Dark Mode">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                    </svg>
                </button>
                <!-- Settings -->
                <button id="settings-btn" class="p-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors" title="Settings">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"/>
                    </svg>
                </button>
                <!-- Export Chat -->
                <button id="export-btn" class="p-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors" title="Export Chat">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"/>
                    </svg>
                </button>
            </div>
            
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 bg-blue-700 rounded-lg flex items-center justify-center shadow-md">
                    <span class="text-white font-bold text-xl">A</span>
                </div>
                <div>
                    <span class="text-2xl font-semibold text-blue-700">AMOLO.AI</span>
                    <span id="personality-indicator" class="personality-badge bg-blue-100 text-blue-700"></span>
                </div>
            </div>
            
            <!-- Conversation Switcher -->
            <div id="conversation-tabs" class="flex gap-2 mt-2">
                <button class="conversation-tab active px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium" data-conv="1">Chat 1</button>
                <button class="conversation-tab px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium" data-conv="2">Chat 2</button>
                <button class="conversation-tab px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium" data-conv="3">Chat 3</button>
            </div>
            
            <div id="welcome-section" class="text-center mt-4">
                <div class="flex items-center justify-center gap-2 text-gray-600 mb-3">
                    <svg class="w-4 h-4 text-orange-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                    </svg>
                    <span class="text-sm">Hi there</span>
                </div>
                <h1 class="text-3xl font-normal text-gray-800">Where should we start?</h1>
            </div>
        </div>

        <!-- API Setup Banner -->
        <div id="api-setup-banner" class="mx-4 mb-4 hidden">
            <div class="max-w-4xl mx-auto bg-yellow-100 border-2 border-yellow-500 rounded-lg p-4 shadow-lg">
                <p class="text-sm text-yellow-900 mb-3 font-semibold">‚ö†Ô∏è Add your Google Gemini API key to start</p>
                <div class="flex gap-2">
                    <input type="text" id="api-key-input" placeholder="Paste API key here..." 
                        class="flex-1 px-4 py-2 border-2 border-yellow-500 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                    <button id="save-api-key-btn" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors">
                        Save
                    </button>
                </div>
                <p class="text-xs text-yellow-700 mt-2">
                    Get free key: <a href="https://aistudio.google.com/apikey" target="_blank" class="underline font-semibold">Google AI Studio</a>
                </p>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
                <h2 class="text-2xl font-bold mb-4">Settings</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">AI Personality</label>
                        <select id="personality-select" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="helpful">üòä Helpful & Friendly</option>
                            <option value="professional">üíº Professional</option>
                            <option value="creative">üé® Creative & Fun</option>
                            <option value="technical">ü§ì Technical Expert</option>
                            <option value="concise">‚ö° Concise & Direct</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="typing-indicator-toggle" checked class="w-5 h-5 text-blue-600 rounded">
                            <span class="text-sm font-semibold">Show typing indicator</span>
                        </label>
                    </div>
                    
                    <div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="sound-effects-toggle" class="w-5 h-5 text-blue-600 rounded">
                            <span class="text-sm font-semibold">Enable sound effects</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex gap-2 mt-6">
                    <button id="clear-history-btn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700">
                        Clear History
                    </button>
                    <button id="close-settings-btn" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages Container -->
        <div id="messages-container" class="flex-1 overflow-y-auto px-4 pb-4">
            <div class="max-w-4xl mx-auto space-y-4" id="messages"></div>
        </div>

        <!-- Input Area -->
        <div class="p-4 pb-6">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg p-4">
                    <div class="flex items-end gap-3">
                        <!-- Voice Input Button -->
                        <button id="voice-btn" class="p-3 rounded-full bg-purple-100 hover:bg-purple-200 transition-colors" title="Voice Input">
                            <svg class="w-5 h-5 text-purple-700" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z"/>
                            </svg>
                        </button>
                        
                        <!-- Image Upload Button -->
                        <button id="image-btn" class="p-3 rounded-full bg-green-100 hover:bg-green-200 transition-colors" title="Upload Image">
                            <svg class="w-5 h-5 text-green-700" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/>
                            </svg>
                        </button>
                        <input type="file" id="image-input" accept="image/*" class="hidden">
                        
                        <!-- Text Input -->
                        <textarea 
                            id="message-input" 
                            placeholder="Ask AMOLO.AI anything..." 
                            rows="1"
                            class="flex-1 bg-transparent outline-none text-gray-800 placeholder-gray-400 text-base resize-none max-h-32"
                        ></textarea>
                        
                        <!-- Send Button -->
                        <button id="send-button" 
                            class="p-3 rounded-full bg-purple-300 hover:bg-purple-400 disabled:bg-gray-200 disabled:cursor-not-allowed transition-colors">
                            <svg class="w-5 h-5 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="pb-4 text-center">
            <p class="text-xs text-gray-500">Powered by Google Gemini AI ‚Ä¢ v3.0 Advanced</p>
        </div>
    </div>

    <script>
        // State Management
        let state = {
            apiKey: localStorage.getItem('amolo_api_key') || '',
            darkMode: localStorage.getItem('amolo_dark_mode') === 'true',
            currentConversation: 1,
            conversations: JSON.parse(localStorage.getItem('amolo_conversations') || '{"1":[],"2":[],"3":[]}'),
            personality: localStorage.getItem('amolo_personality') || 'helpful',
            typingIndicator: localStorage.getItem('amolo_typing') !== 'false',
            soundEffects: localStorage.getItem('amolo_sound') === 'true',
            isLoading: false,
            isRecording: false
        };

        // DOM Elements
        const elements = {
            body: document.getElementById('body'),
            messages: document.getElementById('messages'),
            messageInput: document.getElementById('message-input'),
            sendButton: document.getElementById('send-button'),
            voiceBtn: document.getElementById('voice-btn'),
            imageBtn: document.getElementById('image-btn'),
            imageInput: document.getElementById('image-input'),
            themeToggle: document.getElementById('theme-toggle'),
            settingsBtn: document.getElementById('settings-btn'),
            exportBtn: document.getElementById('export-btn'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            clearHistoryBtn: document.getElementById('clear-history-btn'),
            personalitySelect: document.getElementById('personality-select'),
            personalityIndicator: document.getElementById('personality-indicator'),
            typingToggle: document.getElementById('typing-indicator-toggle'),
            soundToggle: document.getElementById('sound-effects-toggle'),
            apiSetupBanner: document.getElementById('api-setup-banner'),
            apiKeyInput: document.getElementById('api-key-input'),
            saveApiKeyBtn: document.getElementById('save-api-key-btn'),
            welcomeSection: document.getElementById('welcome-section'),
            conversationTabs: document.querySelectorAll('.conversation-tab')
        };

        // Initialize
        init();

        function init() {
            if (!state.apiKey) {
                elements.apiSetupBanner.classList.remove('hidden');
            }
            
            if (state.darkMode) {
                elements.body.classList.add('dark-mode');
            }
            
            elements.personalitySelect.value = state.personality;
            elements.typingToggle.checked = state.typingIndicator;
            elements.soundToggle.checked = state.soundEffects;
            updatePersonalityIndicator();
            loadConversation();
            
            // Event Listeners
            elements.sendButton.addEventListener('click', handleSend);
            elements.messageInput.addEventListener('keydown', handleKeyPress);
            elements.voiceBtn.addEventListener('click', handleVoiceInput);
            elements.imageBtn.addEventListener('click', () => elements.imageInput.click());
            elements.imageInput.addEventListener('change', handleImageUpload);
            elements.themeToggle.addEventListener('click', toggleDarkMode);
            elements.settingsBtn.addEventListener('click', () => elements.settingsModal.classList.remove('hidden'));
            elements.closeSettingsBtn.addEventListener('click', () => elements.settingsModal.classList.add('hidden'));
            elements.clearHistoryBtn.addEventListener('click', clearHistory);
            elements.exportBtn.addEventListener('click', exportChat);
            elements.saveApiKeyBtn.addEventListener('click', saveApiKey);
            elements.personalitySelect.addEventListener('change', changePersonality);
            elements.typingToggle.addEventListener('change', (e) => {
                state.typingIndicator = e.target.checked;
                localStorage.setItem('amolo_typing', state.typingIndicator);
            });
            elements.soundToggle.addEventListener('change', (e) => {
                state.soundEffects = e.target.checked;
                localStorage.setItem('amolo_sound', state.soundEffects);
            });
            
            elements.conversationTabs.forEach(tab => {
                tab.addEventListener('click', () => switchConversation(parseInt(tab.dataset.conv)));
            });
        }

        function saveApiKey() {
            const key = elements.apiKeyInput.value.trim();
            if (key && key.startsWith('AIza')) {
                state.apiKey = key;
                localStorage.setItem('amolo_api_key', key);
                elements.apiSetupBanner.classList.add('hidden');
                alert('‚úÖ API key saved!');
            } else {
                alert('‚ö†Ô∏è Invalid API key format');
            }
        }

        function updatePersonalityIndicator() {
            const personalities = {
                helpful: 'üòä Friendly',
                professional: 'üíº Professional',
                creative: 'üé® Creative',
                technical: 'ü§ì Technical',
                concise: '‚ö° Concise'
            };
            elements.personalityIndicator.textContent = personalities[state.personality];
        }

        function changePersonality() {
            state.personality = elements.personalitySelect.value;
            localStorage.setItem('amolo_personality', state.personality);
            updatePersonalityIndicator();
        }

        function switchConversation(convId) {
            state.currentConversation = convId;
            elements.conversationTabs.forEach(tab => {
                if (parseInt(tab.dataset.conv) === convId) {
                    tab.classList.add('active', 'bg-blue-600', 'text-white');
                    tab.classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    tab.classList.remove('active', 'bg-blue-600', 'text-white');
                    tab.classList.add('bg-gray-200', 'text-gray-700');
                }
            });
            loadConversation();
        }

        function loadConversation() {
            elements.messages.innerHTML = '';
            const messages = state.conversations[state.currentConversation] || [];
            messages.forEach(msg => addMessage(msg.content, msg.type, false, msg.reactions));
            if (messages.length === 0) {
                elements.welcomeSection.style.display = 'block';
            } else {
                elements.welcomeSection.style.display = 'none';
            }
        }

        function saveConversation(message, type) {
            if (!state.conversations[state.currentConversation]) {
                state.conversations[state.currentConversation] = [];
            }
            state.conversations[state.currentConversation].push({
                content: message,
                type: type,
                timestamp: new Date().toISOString(),
                reactions: []
            });
            localStorage.setItem('amolo_conversations', JSON.stringify(state.conversations));
        }

        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            localStorage.setItem('amolo_dark_mode', state.darkMode);
            elements.body.classList.toggle('dark-mode');
        }

        function clearHistory() {
            if (confirm('Clear all chat history? This cannot be undone.')) {
                state.conversations = {1:[], 2:[], 3:[]};
                localStorage.setItem('amolo_conversations', JSON.stringify(state.conversations));
                elements.messages.innerHTML = '';
                elements.welcomeSection.style.display = 'block';
                elements.settingsModal.classList.add('hidden');
            }
        }

        function exportChat() {
            const messages = state.conversations[state.currentConversation] || [];
            let text = `AMOLO.AI Chat Export - ${new Date().toLocaleString()}\n\n`;
            messages.forEach(msg => {
                const sender = msg.type === 'user' ? 'You' : 'AMOLO.AI';
                text += `${sender}: ${msg.content}\n\n`;
            });
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `amolo-chat-${Date.now()}.txt`;
            a.click();
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        }

        function handleVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Voice input not supported in this browser');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.onstart = () => {
                state.isRecording = true;
                elements.voiceBtn.classList.add('bg-red-500');
                elements.voiceBtn.innerHTML = '<svg class="w-5 h-5 text-white animate-pulse" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="4"/></svg>';
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                elements.messageInput.value = transcript;
            };
            
            recognition.onend = () => {
                state.isRecording = false;
                elements.voiceBtn.classList.remove('bg-red-500');
                elements.voiceBtn.innerHTML = '<svg class="w-5 h-5 text-purple-700" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z"/></svg>';
            };
            
            recognition.start();
        }

        async function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Show image preview
            const reader = new FileReader();
            reader.onload = (e) => {
                addMessage(`<img src="${e.target.result}" class="max-w-md rounded-lg shadow-md"/>`, 'user', false);
                saveConversation(`[Image uploaded: ${file.name}]`, 'user');
            };
            reader.readAsDataURL(file);
            
            // Note: Gemini vision API would go here
            setTimeout(() => {
                addMessage('Image received! (Note: Image analysis requires Gemini Pro Vision model)', 'ai', false);
            }, 1000);
        }

        function addMessage(content, type, animate = true, reactions = []) {
            elements.welcomeSection.style.display = 'none';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex gap-3 ${type === 'user' ? 'justify-end' : 'justify-start'} ${animate ? 'animate-fade-in' : ''}`;
            
            // Format code blocks
            const formattedContent = content.replace(/```(\w+)?\n([\s\S]+?)```/g, (match, lang, code) => {
                return `<div class="message-code"><small class="text-gray-500">${lang || 'code'}</small><pre>${code.trim()}</pre></div>`;
            });
            
            if (type === 'ai') {
                const msgId = Date.now();
                messageDiv.innerHTML = `
                    <div class="w-10 h-10 bg-blue-700 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-white font-semibold text-sm">A</span>
                    </div>
                    <div class="max-w-2xl">
                        <div class="px-5 py-4 rounded-2xl bg-white/90 backdrop-blur-sm text-gray-800 shadow-sm">
                            <div class="text-base leading-relaxed">${formattedContent}</div>
                        </div>
                        <div class="flex gap-2 mt-2 pl-2">
                            <button class="reaction-btn" onclick="addReaction(${msgId}, 'üëç')">üëç ${reactions.filter(r=>r==='üëç').length || ''}</button>
                            <button class="reaction-btn" onclick="addReaction(${msgId}, '‚ù§Ô∏è')">‚ù§Ô∏è ${reactions.filter(r=>r==='‚ù§Ô∏è').length || ''}</button>
                            <button class="reaction-btn" onclick="addReaction(${msgId}, 'üòÇ')">üòÇ ${reactions.filter(r=>r==='üòÇ').length || ''}</button>
                            <button class="reaction-btn" onclick="addReaction(${msgId}, 'ü§î')">ü§î ${reactions.filter(r=>r==='ü§î').length || ''}</button>
                        </div>
                    </div>
                `;
            } else if (type === 'error') {
                messageDiv.innerHTML = `
                    <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-white font-semibold">!</span>
                    </div>
                    <div class="max-w-2xl px-5 py-4 rounded-2xl bg-red-50 border-2 border-red-300 text-red-800 shadow-sm">
                        <p class="text-sm font-semibold">‚ùå ${content}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="max-w-2xl px-5 py-4 rounded-2xl bg-blue-600 text-white shadow-md">
                        <div class="text-base leading-relaxed">${formattedContent}</div>
                    </div>
                    <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-white font-semibold text-sm">U</span>
                    </div>
                `;
            }
            
            elements.messages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addReaction(msgId, reaction) {
            // Store reaction logic here
            console.log('Reaction added:', msgId, reaction);
        }

        function addLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flex gap-3 animate-fade-in';
            loadingDiv.innerHTML = `
                <div class="w-10 h-10 bg-blue-700 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-white font-semibold text-sm">A</span>
                </div>
                <div class="bg-white/90 backdrop-blur-sm px-5 py-4 rounded-2xl shadow-sm">
                    ${state.typingIndicator ? '<div class="flex gap-1"><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce-dot"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce-dot"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce-dot"></div></div>' : '<span class="text-gray-500 text-sm typing-indicator">Thinking...</span>'}
                </div>
            `;
            elements.messages.appendChild(loadingDiv);
            scrollToBottom();
        }

        function removeLoadingIndicator() {
            const loading = document.getElementById('loading-indicator');
            if (loading) loading.remove();
        }

        function scrollToBottom() {
            elements.messages.scrollTop = elements.messages.scrollHeight;
        }

        function getPersonalityPrompt() {
            const prompts = {
                helpful: "You are a helpful and friendly AI assistant. Be warm, encouraging, and supportive in your responses.",
                professional: "You are a professional AI assistant. Be formal, precise, and business-like in your communication.",
                creative: "You are a creative and fun AI assistant. Be imaginative, use emojis, and make conversations engaging and playful.",
                technical: "You are a technical expert AI assistant. Be precise, use technical terminology, and provide detailed explanations.",
                concise: "You are a concise AI assistant. Give brief, direct answers without unnecessary elaboration."
            };
            return prompts[state.personality] || prompts.helpful;
        }

        async function callGeminiAPI(userMessage) {
            if (!state.apiKey) {
                throw new Error('Please add your API key first');
            }

            const systemPrompt = getPersonalityPrompt();
            const fullMessage = `${systemPrompt}\n\nUser: ${userMessage}`;

            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=${state.apiKey}`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: fullMessage }]
                        }]
                    })
                }
            );

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'API request failed');
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        async function handleSend() {
            const message = elements.messageInput.value.trim();
            if (!message || state.isLoading) return;

            addMessage(message, 'user', true);
            saveConversation(message, 'user');
            elements.messageInput.value = '';
            
            state.isLoading = true;
            elements.sendButton.disabled = true;
            addLoadingIndicator();

            try {
                const aiResponse = await callGeminiAPI(message);
                removeLoadingIndicator();
                addMessage(aiResponse, 'ai', true);
                saveConversation(aiResponse, 'ai');
                
                if (state.soundEffects) {
                    // Play notification sound
                    const audio = new Audio('data:audio/wav;base64,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');
                    audio.play().catch(() => {});
                }
            } catch (error) {
                removeLoadingIndicator();
                addMessage(error.message, 'error', true);
                if (!state.apiKey) {
                    elements.apiSetupBanner.classList.remove('hidden');
                }
            }

            state.isLoading = false;
            elements.sendButton.disabled = false;
            elements.messageInput.focus();
        }
    </script>
</body>
</html>